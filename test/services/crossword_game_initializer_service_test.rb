require "test_helper"

class CrosswordGameInitializerServiceTest < ActiveSupport::TestCase
  setup do
    @sample_words = {
      "cat" => Word.new(romanji: "cat"),
      "dog" => Word.new(romanji: "dog"),
      "bird" => Word.new(romanji: "bird"),
      "fish" => Word.new(romanji: "fish"),
      "bear" => Word.new(romanji: "bear")
    }
    @service = CrosswordGameInitializerService.new(
      word_dictionary: @sample_words,
      words: @sample_words.values,
      words_to_place: 5,
      use_hiragana: false,
      enable_logging: true,
    )
  end

  test "check_grid with all valid words" do
    grid = [
      [ "c", "a", "t", " ", "d", "o", "g" ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "b", "i", "r", "d", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "f", "i", "s", "h", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "b", "e", "a", "r", " ", " ", " " ]
    ]

    assert @service.check_grid(grid)
  end

  test "check_grid with an invalid word" do
    grid = [
      [ "c", "a", "t", " ", "d", "o", "g" ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "b", "i", "r", "d", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "f", "i", "s", "h", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ "i", "n", "v", "a", "l", "i", "d" ]
    ]

    assert_not @service.check_grid(grid)
  end

  test "check_grid with vertical words" do
    grid = [
      [ "c", " ", "b", " ", "f" ],
      [ "a", " ", "i", " ", "i" ],
      [ "t", " ", "r", " ", "s" ],
      [ " ", " ", "d", " ", "h" ],
      [ "d", " ", " ", " ", " " ],
      [ "o", " ", " ", " ", " " ],
      [ "g", " ", " ", " ", " " ]
    ]

    assert @service.check_grid(grid)
  end

  test "check_grid with no words" do
    grid = [
      [ " ", " ", " " ],
      [ " ", " ", " " ],
      [ " ", " ", " " ]
    ]

    assert @service.check_grid(grid)
  end

  test "check_grid with partial words" do
    grid = [
      [ "c", "a", " ", "d", "o" ],
      [ " ", " ", " ", " ", " " ],
      [ "b", "i", " ", "f", "i" ],
      [ " ", " ", " ", " ", " " ],
      [ "b", "e", " ", " ", " " ]
    ]

    assert_not @service.check_grid(grid)
  end

  test "check_grid with vertical and horizontal words" do
    grid = [
      [ "c", "a", "t", " ", "d", "o", "g" ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", "b", " ", " ", " " ],
      [ " ", " ", " ", "i", " ", " ", " " ],
      [ " ", " ", " ", "r", " ", " ", " " ],
      [ " ", " ", " ", "d", "o", "g", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ]
    ]

    assert @service.check_grid(grid)
  end

  test "place_word successfully adds a valid word" do
    grid = [
      [ " ", " ", " ", "b", " ", " ", " " ],
      [ " ", " ", " ", "i", " ", " ", " " ],
      [ " ", " ", " ", "r", " ", " ", " " ],
      [ " ", " ", " ", "d", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ]
    ]
    word = @sample_words["dog"]
    placed_words = [ @sample_words["bird"] ]
    words = @sample_words.values

    assert @service.place_word(grid, word, placed_words, words)
    assert @service.check_grid(grid)
  end

  test "place_word cannot place an invalid word" do
    grid = [
      [ "c", "a", "t", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ]
    ]
    invalid_word = Word.new(romanji: "invalid")
    placed_words = [ @sample_words["cat"] ]
    words = @sample_words.values + [ invalid_word ]

    assert_not @service.place_word(grid, invalid_word, placed_words, words)
    assert @service.check_grid(grid)
  end

  test "add a word to an existing grid" do
    grid = [
      [ "c", "a", "t", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", "b", " ", " ", " " ],
      [ " ", " ", " ", "i", " ", " ", " " ],
      [ " ", " ", " ", "r", " ", " ", " " ],
      [ " ", " ", " ", "d", "o", "g", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ]
    ]
    word = @sample_words["fish"]
    placed_words = [ @sample_words["cat"], @sample_words["bird"], @sample_words["dog"] ]
    assert @service.place_word(grid, word, placed_words, @sample_words.values)
    assert_equal [
      [ "c", "a", "t", " ", " ", " ", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ],
      [ " ", " ", " ", "b", " ", " ", " " ],
      [ " ", " ", "f", "i", "s", "h", " " ],
      [ " ", " ", " ", "r", " ", " ", " " ],
      [ " ", " ", " ", "d", "o", "g", " " ],
      [ " ", " ", " ", " ", " ", " ", " " ]
    ], grid
  end

  test "place specific words" do
    grid = [ [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "u", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "t", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", "w", "a", "k", "a", "w", "a", "k", "a", "s", "h", "i", "i", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "u", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "w", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "a", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ],
    [ " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " " ] ]

    all_words = [ Word.new(romanji: "wakawakashii"), Word.new(romanji: "utsuwa"), Word.new(romanji: "shouhai") ]

    @service = CrosswordGameInitializerService.new(
      word_dictionary: all_words.index_by { |word| word.romanji },
      words: all_words,
      words_to_place: 5,
      use_hiragana: false,
      enable_logging: true,
    )
    word_to_place = Word.new(romanji: "shouhai")
    placed_words = [ Word.new(romanji: "wakawakashii"), Word.new(romanji: "utsuwa") ]
    assert @service.place_word(grid, word_to_place, placed_words, all_words)
  end
end
